# ---------------------------------------------------------------------------
#
# Create Ubuntu-based Foam-Extend image
#
# Build
#   apptainer build fe.sif foam-extend.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: localimage
From: {{ CONTAINERS_DIR }}/basic/{{ BASE_CONTAINER }}.sif

%arguments
    BASE_CONTAINER=opencfd-openfoam
    OS_DISTRO=ubuntu
    OS_VERSION=24.04
    MPI_IMPLEMENTATION=openmpi
    MPI_VERSION=4.1.5
    FRAMEWORK_VERSION=2412

%files 
    ../solver /opt/solver
    ../solids4Foam /opt/solver/thirdParty/solids4Foam
    ../multiRegionFoam  /opt/solver/thirdParty/multiRegionFoam
  


%post -c /bin/bash

	apt-get install -y --no-install-recommends \
		wget curl
		
    

    
    source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc

    # Set user build paths to system paths (override sandbox behavior)
    export FOAM_USER_APPBIN=$FOAM_APPBIN
    export FOAM_USER_LIBBIN=$FOAM_LIBBIN

    # Build custom solver for mold injection
    
    # Go to multiRegionFoam directory
    cd /opt/solver/thirdParty/multiRegionFoam

    # Fix filesToReplace
    cp -r filesToReplace/IOReferencer /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/src/OpenFOAM/db/IOobjects/
    wmakeLnInclude -f /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/src/OpenFOAM

    cp filesToReplace/GeometricField.H /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/src/OpenFOAM/fields/GeometricFields/GeometricField/
    wmake libso /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/src/OpenFOAM

    # Build multiRegionFoam
    ./Allwmake -j 
    
    # Build custom solver for solids4Foam (warpage)
    cd /opt/solver/thirdParty/solids4Foam
    export S4F_NO_FILE_FIXES=1
    ./Allwmake -j
    
    # Build IMFoam solver
    ssh -o StrictHostKeyChecking=no git@bitbucket.org
    cd /opt/solver 
    ./Allwmake -j -s
    wmake applications/solvers/IMFluid/
        
       

%environment
    

%runscript
    #!/bin/bash
    #/bin/bash -c 'source /usr/lib/openfoam/openfoam2412/etc/bashrc && mkdir -p $FOAM_USER_LIBBIN && mkdir -p $FOAM_USER_APPBIN'
	source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc
	eval $(foamEtcFile -sh -config petsc -- -force)
	
    if [ $# -eq 0 ]; then
        /bin/bash -c "/bin/bash --login"
    else
        /bin/bash -c "$@"
    fi
    

%labels
    Description Ubuntu-based Foam-Extend image with OpenMPI
    
