# ---------------------------------------------------------------------------
#
# Create Ubuntu-based ESI OpenFOAM image
#
# Build
#   apptainer build of.sif com-openfoam.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: localimage
#From:containers/basic/{{ BASE_CONTAINER }}.sif
From:containers/basic/{{ OS_DISTRO }}-{{ OS_VERSION }}-{{MPI_IMPLEMENTATION}}-{{ MPI_VERSION }}.sif

%arguments
    OS_DISTRO=ubuntu
    OS_VERSION=24.04
    MPI_IMPLEMENTATION=openmpi
    MPI_VERSION=4.1.5
    FRAMEWORK_VERSION=2412
    FRAMEWORK_GIT_REF=OpenFOAM-v2412
    THIRDPARTY_GIT_REF=v2412

%post -c /bin/bash
    DEBIAN_FRONTEND=noninteractive
    if [[ {{ FRAMEWORK_GIT_REF }} == "default" ]]; then
        curl https://dl.openfoam.com/add-debian-repo.sh | bash
        apt-get -y install --no-install-recommends openfoam{{ FRAMEWORK_VERSION }} python3
    else

		echo "**************** install requirments ****************"
        apt update && apt install -y --no-install-recommends \
			build-essential \
			cmake \
			autoconf \
			autotools-dev \
			gawk \
			git \
			curl \
			wget \
			ca-certificates \
			flex \
			libfl-dev \
			libreadline-dev \
			zlib1g-dev \
			libgmp-dev \
			libmpfr-dev \
			libmpc-dev \
			libfftw3-dev \
			libscotch-dev \
			libptscotch-dev \
			libboost-system-dev \
			libboost-thread-dev \
			libcgal-dev \
			libopenmpi-dev \
			openmpi-bin \
			mpi-default-dev \
			mpi-default-bin \
			binutils \
			bison \
			libncurses-dev \
			libxt-dev \
			libglu1-mesa-dev \
			libxrender-dev \
			libxext-dev \
			libxrandr-dev \
			libxi-dev \
			m4 \
			python3 

		apt update && apt install -y --no-install-recommends libblas-dev liblapack-dev gfortran 

            
        echo "**************** download openfoam ****************"
        mkdir -p /usr/lib/openfoam
        git clone https://develop.openfoam.com/Development/openfoam /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}
        git checkout {{ FRAMEWORK_GIT_REF }}
        
        # Override the fallback logic in etc/bashrc
		sed -i 's|projectDir="\$HOME/OpenFOAM/OpenFOAM-\$WM_PROJECT_VERSION"|projectDir="/usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}"|' /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc

		echo "**************** download third party ****************"
        git clone https://develop.openfoam.com/Development/ThirdParty-common.git /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty
        git checkout {{ THIRDPARTY_GIT_REF }}
        
        echo "**************** get petsc *****************************"
        wget https://web.cels.anl.gov/projects/petsc/download/release-snapshots/petsc-lite-3.21.2.tar.gz
        tar -xzf petsc-lite-3.21.2.tar.gz
        
        
        echo "**************** get petsc4Foam *****************************"
        mkdir -p /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/modules/
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/modules/
        git clone https://develop.openfoam.com/modules/external-solver.git
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/modules/external-solver
        git checkout {{ THIRDPARTY_GIT_REF }}
        
		
        echo "**************** get scotch *****************************"
        mkdir -p  /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/sources/scotch/
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/sources/scotch/
		wget https://gitlab.inria.fr/scotch/scotch/-/archive/v6.1.0/scotch-v6.1.0.tar.gz -O scotch_6.1.0.tar.gz
		tar -xzf scotch_6.1.0.tar.gz
		mv scotch-v6.1.0 scotch_6.1.0
		#cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty
    	
    	
        
        echo "**************** install openfoam ****************"	
        source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}
        echo "compile mix presicion ..."
        (export WM_PRECISION_OPTION=SPDP && ./Allwmake -j -s -q -l)
        
        #echo "compile double presicion ..."
        #(export WM_PRECISION_OPTION=DP && ./Allwmake -j -s -q -l)
        
        echo "**************** install petsc ****************"
        cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/
	./makePETSC
		
	echo "**************** install petsc4Foam ****************"
	cd /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/ThirdParty/modules/external-solver/
	./Allwmake -prefix=openfoam

        
        
    fi
    jq --arg app openfoam --arg commit {{ FRAMEWORK_GIT_REF }} \
        --arg branch {{ FRAMEWORK_GIT_REF }} \
        '.[$app] |= if . == null then
        {
            fork: "com-openfoam",
            branch: $branch,
            commit: $commit,
            source_script: "/usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc",
            version: "{{ FRAMEWORK_VERSION }}"
        }
        else . +
        {
            fork: "com-openfoam",
            branch: $branch,
            commit: $commit,
            source_script: "/usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc",
            version: "{{ FRAMEWORK_VERSION }}"
        } end' /apps.json > /tmp/apps.json
    mv /tmp/apps.json /apps.json
    

%runscript
    #!/bin/bash
    source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc
    eval $(foamEtcFile -sh -config petsc -- -force)
    if [ $# -eq 0 ]; then
        /bin/bash -c "/bin/bash --login"
    else
        /bin/bash -c "$@"
    fi

%labels
    Maintainer Mohammed Elwardi Fadeli
    Description Ubuntu-based ESI OpenFOAM image with OpenMPI
    AppsFile /apps.json
