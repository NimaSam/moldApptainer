# ---------------------------------------------------------------------------
#
# Create Ubuntu-based Foam-Extend image
#
# Build
#   apptainer build fe.sif foam-extend.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: localimage
From: {{ CONTAINERS_DIR }}/basic/{{ BASE_CONTAINER }}.sif

%arguments
    BASE_CONTAINER=opencfd-openfoam
    OS_DISTRO=ubuntu
    OS_VERSION=24.04
    MPI_IMPLEMENTATION=openmpi
    MPI_VERSION=4.1.5
    FRAMEWORK_VERSION=2312

%files 
    ../solver /opt/solver
    ../solids4Foam /opt/solids4Foam
  


%post -c /bin/bash

	apt-get install -y --no-install-recommends \
		wget curl 
    

    
    source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc

    # Set user build paths to system paths (override sandbox behavior)
    export FOAM_USER_APPBIN=$FOAM_APPBIN
    export FOAM_USER_LIBBIN=$FOAM_LIBBIN

    # Build custom solver for mold injection
    cd /opt/solver
    ./Allwmake -j
    
    # Build custom solver for solids4Foam (warpage)
    cd /opt/solids4Foam
    export S4F_NO_FILE_FIXES=1
    ./Allwmake -j
   
    
       

%environment
    

%runscript
    #!/bin/bash
    #/bin/bash -c 'source /usr/lib/openfoam/openfoam2312/etc/bashrc && mkdir -p $FOAM_USER_LIBBIN && mkdir -p $FOAM_USER_APPBIN'
    if [ $# -eq 0 ]; then
        /bin/bash -c "source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc && /bin/bash --login"
    else
        /bin/bash -c "source /usr/lib/openfoam/openfoam{{ FRAMEWORK_VERSION }}/etc/bashrc && $@"
    fi
    

%labels
    Description Ubuntu-based Foam-Extend image with OpenMPI
    
